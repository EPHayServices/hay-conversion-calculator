<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hay Potential Calculator</title>

<!-- KaTeX (for formulas in the guide only) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

<!-- jsPDF for exporting the Yield Guide -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --green:#006400; --green-dark:#005000; --ink:#222; --muted:#6b7280;
    --bg:#f6f7f8; --card:#ffffff; --line:#e5e7eb; --soft:#f3f4f6;
  }
  html,body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{margin:0; padding:16px}
  .wrap{max-width:900px;margin:0 auto}
  h1,h2,h3{color:var(--green);line-height:1.25;margin:0 0 .6rem}
  h1{font-size:1.8rem} h2{font-size:1.25rem;margin-top:1.2rem} h3{font-size:1.05rem;margin-top:1rem}
  p{line-height:1.45} .muted{color:var(--muted)} .small{font-size:.9rem} .tiny{font-size:.82rem}
  .spacer-xs{height:6px} .spacer-sm{height:10px} .spacer{height:14px} .spacer-lg{height:18px}

  .panel{background:#fff;border:1px solid var(--green);border-top:none;border-radius:0 12px 12px 12px;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .soft{background:var(--soft);border-radius:10px;padding:12px}

  .tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:0}
  .tab{white-space:nowrap;padding:10px 12px;border:1px solid var(--line);border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;background:#f3f4f6;color:#374151;font-weight:700}
  .tab.active{background:#fff;color:var(--green);border-color:var(--green)}

  form{display:block}
  label{display:block;font-weight:700;margin:10px 0 6px}
  input,select,button{width:100%;box-sizing:border-box;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:1rem;line-height:1.2}
  input + .hint,select + .hint{margin:6px 0 12px;color:var(--muted)}
  .error{color:#8B0000;margin-top:6px;margin-bottom:10px;font-size:.9rem;min-height:1.1em}
  .btn{display:block;width:100%;padding:14px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
  .btn-primary{background:var(--green);color:#fff}.btn-primary:hover{background:var(--green-dark)}
  .btn-neutral{background:#374151;color:#fff}.btn-outline{background:#fff;border:1px solid var(--line)}
  .btn + .btn{margin-top:8px}

  .service-item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px dashed var(--line)}
  .service-item:last-child{border-bottom:none}
  .service-item input[type=checkbox]{width:auto;margin-top:4px}
  .service-item label{margin:0;font-weight:600}

  /* Prevent bunching/overlap on mobile */
  .stack{display:block; position:relative; clear:both; margin-block:16px;}
  .result{background:var(--soft);border-radius:10px;padding:12px}
  #profit-section{background:#f7f8fa;border:1px solid var(--line);border-radius:10px;padding:12px}
  .katex, .katex-display{ line-height:1.25; margin:8px 0 !important; }

  /* Conversion table */
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border:1px solid #e5e7eb;padding:8px;text-align:right}
  .table th:first-child,.table td:first-child{text-align:left}
  .sticky-head{position:sticky;top:0;background:#fff}
  .rowcard{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;margin-bottom:12px}
  .rowhead{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .rowtitle{font-weight:800;color:var(--green);text-transform:capitalize}
  .factor-ctrl{display:flex;gap:10px;align-items:center;margin-top:8px}
  .factor-ctrl input[type=range]{flex:1}
  .micro{font-size:.75rem;color:var(--muted)}

  .callout{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .callout h3{margin:0 0 .5rem;color:#006400;font-size:1.05rem}
  .step-list{margin:.5rem 0 0 1rem;padding:0} .step-list li{margin:.5rem 0}
  .badge{display:inline-block;background:#e6f6e6;color:#065f46;border:1px solid #b7ebc0;padding:.15rem .5rem;border-radius:999px;font-size:.78rem;font-weight:700}
  .sample{border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:10px;background:#fff}
  .actions-row{display:flex;gap:8px;flex-wrap:wrap}

  .logo-box{text-align:center;margin-bottom:12px}.logo{max-width:150px;height:auto;border-radius:10px}

  @media (min-width:920px){.panel{padding:20px}}
  @media print{.tabs,.btn{display:none !important}.panel{border-color:#ddd}}
</style>
</head>
<body>
<div class="wrap">

  <div class="logo-box">
    <img src="logo.png" alt="Logo" class="logo">
  </div>

  <div class="tabs">
    <button class="tab active" id="tab-calculator">Calculator</button>
    <button class="tab" id="tab-guide">Yield Guide</button>
    <button class="tab" id="tab-conv">Conversion Table</button>
  </div>

  <!-- ===== Calculator ===== -->
  <div class="panel" id="panel-calculator">
    <h1>Hay Potential Calculator</h1>

    <form id="hayCalculator" novalidate>
      <h2>Enter Paddock Details</h2>

      <label for="paddockSize">Hectares</label>
      <input type="number" id="paddockSize" placeholder="100" step="any" inputmode="decimal">
      <div class="hint tiny">Leave blank for single-bale mode (we assume 1 ha internally but show per-bale costs).</div>
      <div id="err-hectares" class="error"></div>

      <label for="hayType">Crop Type</label>
      <select id="hayType" required>
        <option value="wheat">Wheat</option>
        <option value="barley">Barley</option>
        <option value="oats">Oats</option>
        <option value="vetch">Vetch</option>
        <option value="medic">Medic</option>
      </select>
      <div id="err-crop" class="error"></div>

      <div id="grainYieldSection">
        <label for="expectedGrainYield">Expected Grain Yield (t/ha)</label>
        <input type="number" id="expectedGrainYield" step="any" placeholder="3.5" inputmode="decimal">
        <div class="hint tiny">Optional for grain crops if you provide a manual hay yield below.</div>
        <div id="err-grain" class="error"></div>
      </div>

      <label for="estimatedHayYieldPerHa">Estimated Hay Yield (t/ha)</label>
      <input type="number" id="estimatedHayYieldPerHa" step="any" placeholder="Leave blank to use conversion defaults" inputmode="decimal">
      <div class="hint tiny">Required for Medic. For grain crops, you can enter this to override conversion.</div>
      <div id="err-hay" class="error"></div>

      <h2>Services Required</h2>
      <p class="tiny muted">*Client to provide diesel; allowance included in costs per bale.</p>

      <div class="service-item">
        <input type="checkbox" id="service-mowing" checked>
        <label for="service-mowing">Mowing — DC163 Case IH Mower Conditioner / SP Mower</label>
      </div>
      <div class="service-item">
        <input type="checkbox" id="service-raking" checked>
        <label for="service-raking">Raking</label>
      </div>
      <div class="service-item">
        <input type="checkbox" id="service-baling" checked>
        <label for="service-baling">Baling — Krone HD Baler (750 kg per bale)</label>
      </div>

      <div class="spacer"></div>
      <button class="btn btn-primary" type="submit" id="btn-calc">Calculate</button>
      <button class="btn btn-outline" type="button" id="btn-print">Print / Save PDF</button>
      <button class="btn btn-neutral" type="button" id="btn-reset">Reset</button>
    </form>

    <div id="mode-note" class="tiny muted stack" style="display:none;">
      Single-bale mode: hectares were blank, so results emphasise per-bale figures.
    </div>

    <div id="results" class="stack"></div>

    <div id="profit-section" class="stack" style="display:none">
      <h2>Hay Market Returns & Profit Comparison</h2>
      <p class="small">Enter <strong>farm-gate</strong> prices (after freight).</p>

      <label for="hay-price">Hay Price ($/t)</label>
      <input type="number" id="hay-price" step="any" inputmode="decimal" placeholder="e.g., 200">
      <div id="err-hayprice" class="error"></div>

      <div id="grainFinancialsSection">
        <label for="grain-price">Grain Price ($/t)</label>
        <input type="number" id="grain-price" step="any" inputmode="decimal" placeholder="e.g., 300">
        <div id="err-grainprice" class="error"></div>
      </div>

      <button class="btn btn-primary" id="calculate-profit-btn" type="button">Calculate Profit</button>
      <div id="profit-results" class="stack"></div>
    </div>
  </div>

  <!-- ===== Yield Guide ===== -->
  <div class="panel" id="panel-guide" style="display:none">
    <h2>Dry Matter (DM) Cut &amp; Weigh — How to Collect Data</h2>

    <div class="callout">
      <h3>What you need</h3>
      <ul class="step-list">
        <li>✅ <strong>1 m × 1 m quadrat</strong> (PVC or string frame)</li>
        <li>✅ <strong>Sharp shears/knife</strong> &amp; bucket/bag for clippings</li>
        <li>✅ <strong>Scales</strong> (gram accuracy) — one for field (portable) and one for bench</li>
        <li>✅ <strong>Microwave</strong> <em>or</em> forced-air oven (bench step)</li>
        <li>✅ Heat-safe dish, paper towel, notebook/phone</li>
      </ul>
    </div>

    <div class="spacer-xs"></div>

    <div class="callout">
      <h3>Where &amp; when to sample</h3>
      <ul class="step-list">
        <li><strong>Choose 3–5 representative spots</strong> across the paddock (avoid headlands, bare patches, unusually lush drains).</li>
        <li><strong>Timing:</strong> when you’re deciding whether to cut — typically late boot to early heading for cereals; avoid sampling after rain or heavy dew if possible.</li>
      </ul>
    </div>

    <div class="spacer-xs"></div>

    <div class="callout">
      <h3>Field steps (for each sample)</h3>
      <ol class="step-list">
        <li><strong>Place quadrat.</strong> Lay the 1 m² frame on representative crop; note the planned cutting height.</li>
        <li><strong>Cut everything inside the frame</strong> at that height. Include stems + leaves; exclude stones and soil.</li>
        <li><strong>Weigh immediately:</strong> record <strong>W<sub>wet</sub></strong> (total wet biomass in grams) to reduce moisture drift.</li>
        <li><strong>Take a sub-sample</strong> (~100 g) from the cut biomass; record its wet weight <strong>S<sub>wet</sub></strong> (g).</li>
      </ol>
    </div>

    <div class="spacer-xs"></div>

    <div class="callout">
      <h3>Bench steps (determine Dry Matter %)</h3>
      <ol class="step-list">
        <li><strong>Dry the sub-sample</strong> to constant weight:
          <ul>
            <li><em>Microwave:</em> 1–2 min bursts, cool 1 min, re-weigh; repeat until change &lt; 0.5 g. <span class="badge">Caution</span> Don’t scorch.</li>
            <li><em>Oven:</em> 60–65 °C with airflow, usually overnight; weigh after cooling in a dry container.</li>
          </ul>
        </li>
        <li>Record <strong>S<sub>dry</sub></strong> (g), then compute Dry Matter:
          <div class="tiny muted">$$ \\text{DM}\\% = \\frac{S_{\\text{dry}}}{S_{\\text{wet}}} \\times 100 $$</div>
        </li>
        <li>Apply DM% to the field sample to get dry mass per m²:
          <div class="tiny muted">$$ W_{\\text{dry}}(\\text{g}) = W_{\\text{wet}}(\\text{g}) \\times \\frac{\\text{DM}\\%}{100} $$</div>
        </li>
        <li>Convert to yield (t/ha):
          <div class="tiny muted">$$ \\text{DM Yield (t/ha)} = \\frac{W_{\\text{dry}}(\\text{g})}{100} $$</div>
        </li>
      </ol>
      <p class="tiny muted"><strong>Tip:</strong> “Constant weight” = two successive weighings (after cool-down) differ by &lt;0.5–1 g.</p>
    </div>

    <div class="spacer"></div>

    <h2>Enter Your Samples</h2>
    <p class="small">Add 3–10 samples. The guide computes <strong>DM%</strong>, <strong>W<sub>dry</sub></strong>, and <strong>DM yield (t/ha)</strong> per sample, then averages across samples. Your inputs are saved until you clear them.</p>

    <div id="samples"></div>
    <div class="actions-row">
      <button class="btn btn-outline" id="add-sample" type="button">Add Sample</button>
      <button class="btn btn-outline" id="clear-samples" type="button">Clear Samples</button>
      <button class="btn btn-outline" id="export-yield-pdf" type="button">Export PDF</button>
    </div>

    <div class="spacer-sm"></div>
    <div class="card soft" id="dm-summary">
      <div><strong>Average DM Yield:</strong> <span id="avg-dm-yield">0.00</span> t/ha</div>
      <div class="tiny muted">Formulas above: \( W_{\text{dry}} = W_{\text{wet}} \times \frac{\text{DM}\%}{100} \); \( \text{DM t/ha} = \frac{W_{\text{dry}}}{100} \)</div>
      <div class="spacer-xs"></div>
      <button class="btn btn-primary" id="push-to-calculator" type="button">Use this yield in Calculator</button>
    </div>
  </div>

  <!-- ===== Conversion Table ===== -->
  <div class="panel" id="panel-conv" style="display:none">
    <h2>Conversion Table (Grain → Hay)</h2>

    <div class="card soft" style="margin-bottom:12px">
      <h3 style="margin-top:0">How to use this table</h3>
      <p class="small">
        This table converts <strong>grain yield</strong> (t/ha) into <strong>potential hay yield</strong> (t/ha) with a
        per-crop <em>Conversion Factor</em> that you can adjust. Use the slider (or number box) beside each crop to reflect
        your local conditions. The default factors match your spreadsheet and will be used by the main Calculator whenever
        “Estimated Hay Yield” is left blank.
      </p>

      <p class="small">Core relationship:</p>
      <div class="tiny muted">$$ \text{Hay Yield (t/ha)} \;=\; \text{Grain Yield (t/ha)} \times \text{Conversion Factor} $$</div>

      <h3>Where the factors come from</h3>
      <p class="small">
        We start from the crop’s <strong>Harvest Index (HI)</strong>, the fraction of total above-ground dry matter that ends up as grain:
      </p>
      <div class="tiny muted">$$ \mathrm{HI} \;=\; \frac{\text{Grain DM}}{\text{Grain DM} + \text{Straw/Residue DM}} $$</div>
      <p class="small">Rearranging gives the non-grain biomass relative to grain:</p>
      <div class="tiny muted">$$ \frac{\text{Straw DM}}{\text{Grain DM}} \;=\; \left(\frac{1}{\mathrm{HI}} - 1\right) $$</div>
      <p class="small">
        Not all biomass is recovered into bales. Let <strong>E</strong> be field recovery efficiency (covers cutting/raking/baling losses).
        A simple theoretical factor is:
      </p>
      <div class="tiny muted">$$ \text{Factor}_\text{theoretical} \;=\; \left(\frac{1}{\mathrm{HI}} - 1\right) \times E $$</div>
      <p class="small">
        The <strong>default factors</strong> here (Wheat 1.9, Barley 1.7, Oats 2.3, Vetch 2.6, Medic 2.6) are calibrated to your
        historical results and spreadsheet—not a single HI/E pair—so they already account for cutting height, leaf/head capture,
        swath density and typical operating practice. Adjust the sliders to suit your paddock; press <em>Save Factors</em> to reuse
        them across the Calculator, or <em>Reset Defaults</em> to restore the spreadsheet values.
      </p>

      <h3>Columns</h3>
      <ul class="small" style="margin-top:.25rem">
        <li><strong>Grain (t/ha):</strong> reference yields (0.5 → 5.0).</li>
        <li><strong>Hay (t/ha):</strong> Grain × Factor.</li>
        <li><strong>Bales/ha:</strong> \( \text{Hay} / 0.75 \) (750 kg bale).</li>
        <li><strong>Cost/ha ($):</strong> Cutting $60/ha + Raking $5/ha + Baling $28/bale × Bales.</li>
        <li><strong>Cost/bale ($):</strong> \( \text{Cost/ha} \div \text{Bales} \).</li>
      </ul>
    </div>

    <div id="conv-rows"></div>

    <div class="actions-row">
      <button class="btn btn-primary" id="save-factors" type="button">Save Factors</button>
      <button class="btn btn-outline" id="reset-factors" type="button">Reset Defaults</button>
    </div>

    <div class="spacer-sm"></div>
    <div class="micro">Rates used: Cutting $60/ha • Raking $5/ha • Baling $28/bale • Bale size 0.75 t</div>
  </div>

  <div class="spacer"></div>
  <div class="card soft tiny muted">
    *Estimates only. Actual paddock results and market returns vary. Not financial advice.
  </div>
</div>

<script>
/* =========================
   Global Config & Defaults
=========================*/
const RATES = { cutting_per_ha:60, raking_per_ha:5, baling_per_bale:28 }; // change baling here if needed
const BALE_TONNES = 0.75;  // 750 kg per bale

const DEFAULT_FACTORS = { wheat:1.9, barley:1.7, oats:2.3, vetch:2.6, medic:2.6 };
const GRAIN_STEPS = [0.5,1,1.5,2,2.5,3,3.5,4,4.5,5];

/* Tabs */
const tabCalc = document.getElementById('tab-calculator');
const tabGuide = document.getElementById('tab-guide');
const tabConv  = document.getElementById('tab-conv');
const pCalc = document.getElementById('panel-calculator');
const pGuide = document.getElementById('panel-guide');
const pConv = document.getElementById('panel-conv');

function activate(tab){
  [tabCalc,tabGuide,tabConv].forEach(t=>t.classList.remove('active'));
  [pCalc,pGuide,pConv].forEach(p=>p.style.display='none');
  if(tab==='calc'){ tabCalc.classList.add('active'); pCalc.style.display='block'; }
  if(tab==='guide'){ tabGuide.classList.add('active'); pGuide.style.display='block'; }
  if(tab==='conv'){ tabConv.classList.add('active'); pConv.style.display='block'; }
}
tabCalc.onclick = ()=>activate('calc');
tabGuide.onclick = ()=>activate('guide');
tabConv.onclick  = ()=>activate('conv');

/* Factors persistence */
function loadFactors(){
  const raw = localStorage.getItem('convFactors');
  if(!raw) return {...DEFAULT_FACTORS};
  try{ const obj = JSON.parse(raw); return {...DEFAULT_FACTORS, ...obj}; } catch { return {...DEFAULT_FACTORS}; }
}
function saveFactors(f){ localStorage.setItem('convFactors', JSON.stringify(f)); }
function resetFactors(){ localStorage.removeItem('convFactors'); }
let FACTORS = loadFactors();

/* Conversion Table UI */
const convRows = document.getElementById('conv-rows');

function renderConvCard(crop){
  const f = FACTORS[crop];
  const card = document.createElement('div');
  card.className = 'rowcard';
  card.dataset.crop = crop;
  card.innerHTML = `
    <div class="rowhead">
      <div class="rowtitle">${crop}</div>
      <div style="text-align:right"><strong>Factor:</strong> <span class="factor-val">${f.toFixed(2)}</span>×</div>
    </div>
    <div class="factor-ctrl">
      <input type="range" min="0.50" max="3.00" step="0.01" value="${f}" class="f-range">
      <input type="number" min="0.5" max="3.0" step="0.01" value="${f}" class="f-num" style="width:110px" inputmode="decimal">
    </div>
    <div class="spacer-xs"></div>
    <div class="soft">
      <div class="micro"><strong>Table:</strong> Grain yield × Factor → Hay t/ha & bales/ha. Costs use rates above.</div>
      <div class="spacer-xs"></div>
      <div class="table-wrap"></div>
    </div>
  `;
  buildSmallTable(card, crop);
  const range = card.querySelector('.f-range');
  const num = card.querySelector('.f-num');
  const out = card.querySelector('.factor-val');
  function setFactor(val){
    const v = Math.max(0.5, Math.min(3.0, Number(val)||DEFAULT_FACTORS[crop]));
    range.value = v.toFixed(2); num.value = v.toFixed(2); out.textContent = v.toFixed(2);
    FACTORS[crop] = v;
    buildSmallTable(card, crop);
  }
  range.addEventListener('input', e=>setFactor(e.target.value));
  num.addEventListener('input', e=>setFactor(e.target.value));
  return card;
}

function buildSmallTable(card, crop){
  const f = FACTORS[crop];
  const wrap = card.querySelector('.table-wrap');
  const tbl = document.createElement('table');
  tbl.className='table';
  tbl.innerHTML = `
    <thead class="sticky-head">
      <tr>
        <th>Grain (t/ha)</th>
        <th>Hay (t/ha)</th>
        <th>Bales/ha</th>
        <th>Cost/ha ($)</th>
        <th>Cost/bale ($)</th>
      </tr>
    </thead>
    <tbody>
      ${GRAIN_STEPS.map(g=>{
        const hay = g * f;
        const bales = hay / BALE_TONNES;
        const costHa = RATES.cutting_per_ha + RATES.raking_per_ha + (bales * RATES.baling_per_bale);
        const costPerBale = bales>0 ? (costHa / bales) : 0;
        return `<tr>
          <td>${g.toFixed(1)}</td>
          <td>${hay.toFixed(2)}</td>
          <td>${bales.toFixed(3)}</td>
          <td>${costHa.toFixed(2)}</td>
          <td>${costPerBale.toFixed(2)}</td>
        </tr>`;
      }).join('')}
    </tbody>
  `;
  wrap.innerHTML = '';
  wrap.appendChild(tbl);
}

function renderConvTab(){
  convRows.innerHTML='';
  ['wheat','barley','oats','vetch','medic'].forEach(crop=>{
    convRows.appendChild(renderConvCard(crop));
  });
}

document.getElementById('save-factors').onclick = ()=>{
  saveFactors(FACTORS);
  alert('Conversion factors saved. The Calculator will use these when no manual hay yield is entered.');
};
document.getElementById('reset-factors').onclick = ()=>{
  if(confirm('Reset conversion factors to defaults?')){
    resetFactors();
    FACTORS = loadFactors();
    renderConvTab();
  }
};

/* ===== Calculator ===== */
const form = document.getElementById('hayCalculator');
const hayTypeSel = document.getElementById('hayType');
const grainSection = document.getElementById('grainYieldSection');
const expectedGrainYieldInput = document.getElementById('expectedGrainYield');
const estimatedHayYieldPerHaInput = document.getElementById('estimatedHayYieldPerHa');
const resultsDiv = document.getElementById('results');
const profitSection = document.getElementById('profit-section');
const profitResultsDiv = document.getElementById('profit-results');
const modeNote = document.getElementById('mode-note');

const err = {
  crop: document.getElementById('err-crop'),
  grain: document.getElementById('err-grain'),
  hay: document.getElementById('err-hay'),
  hayprice: document.getElementById('err-hayprice'),
  grainprice: document.getElementById('err-grainprice')
};

function toggleGrainVisibility(){
  const isMedic = hayTypeSel.value==='medic';
  grainSection.style.display = isMedic ? 'none' : 'block';
  document.getElementById('grainFinancialsSection').style.display = isMedic ? 'none' : 'block';
}
hayTypeSel.addEventListener('change', toggleGrainVisibility);

function fmtMoney(n){ return isFinite(n)? new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n) : '0.00'; }
function clearErrors(){ Object.values(err).forEach(e=>e.textContent=''); }

let lastCalc = {};

form.addEventListener('submit', (e)=>{
  e.preventDefault();
  clearErrors();

  const paddockSizeRaw = document.getElementById('paddockSize').value.trim();
  const paddockSize = parseFloat(paddockSizeRaw) || 1;
  const hectaresProvided = paddockSizeRaw !== '';
  modeNote.style.display = hectaresProvided ? 'none' : 'block';

  const crop = hayTypeSel.value;
  const isMedic = crop==='medic';

  const manualHayFilled = estimatedHayYieldPerHaInput.value.trim() !== '';
  const grainFilled = expectedGrainYieldInput.value.trim() !== '';
  const expectedGrain = isMedic ? 0 : (parseFloat(expectedGrainYieldInput.value) || 0);
  const manualHay = parseFloat(estimatedHayYieldPerHaInput.value);

  // Validation
  let bad=false;
  if(!crop){ err.crop.textContent='Select a crop type.'; bad=true; }
  if(!isMedic){
    if(!manualHayFilled && (!grainFilled || expectedGrain<=0)){
      err.grain.textContent='Enter Expected Grain Yield (>0) or provide an Estimated Hay Yield.';
      bad=true;
    }
  }else{
    if(!manualHayFilled || isNaN(manualHay) || manualHay<=0){
      err.hay.textContent='Medic requires an Estimated Hay Yield (>0).';
      bad=true;
    }
  }
  if(bad){ resultsDiv.innerHTML=''; profitSection.style.display='none'; return; }

  // Yield determination (manual > factor)
  let hayYieldPerHa = 0, factorUsed = 0, method = '';

  if(manualHayFilled && manualHay>0){
    hayYieldPerHa = manualHay;
    method = "Manual hay yield (client input)";
    factorUsed = expectedGrain>0 ? (hayYieldPerHa/expectedGrain) : 0;
  }else{
    const f = FACTORS[crop] ?? DEFAULT_FACTORS[crop];
    if(isMedic || !f || expectedGrain<=0){
      resultsDiv.innerHTML = `<p class="tiny" style="color:#8B0000">Invalid inputs for conversion.</p>`;
      profitSection.style.display='none';
      return;
    }
    factorUsed = f;
    hayYieldPerHa = expectedGrain * factorUsed;
    method = "Default/Custom Grain→Hay conversion";
  }

  // Totals & costs
  const totalT = paddockSize * hayYieldPerHa;
  const bales = totalT / BALE_TONNES;

  let totalCost = 0;
  if(document.getElementById('service-mowing').checked) totalCost += paddockSize * RATES.cutting_per_ha;
  if(document.getElementById('service-raking').checked) totalCost += paddockSize * RATES.raking_per_ha;
  if(document.getElementById('service-baling').checked) totalCost += bales * RATES.baling_per_bale;

  const costPerBale = bales>0 ? (totalCost/bales) : 0;
  const costPerHa = paddockSize>0 ? (totalCost/paddockSize) : 0;

  lastCalc = { paddockSize, hectaresProvided, hayYieldPerHa, totalT, bales, totalCost, expectedGrain };

  const factorHtml = (factorUsed>0 && !isMedic) ? `<p><strong>Implied Factor:</strong> ${factorUsed.toFixed(2)}</p>` : '';

  // NOTE: No conversion math line is rendered anymore.
  resultsDiv.innerHTML = `
    <div class="result">
      <h3>Results</h3>
      <p><strong>Hay Yield:</strong> ${hayYieldPerHa.toFixed(2)} t/ha</p>
      <p><strong>Method:</strong> ${method}</p>
      ${factorHtml}
      <hr style="border:none;border-top:1px solid var(--line);margin:10px 0">
      <p><strong>Total Yield:</strong> ${totalT.toFixed(2)} t</p>
      <p><strong>Total Bales (@ ${(BALE_TONNES*1000).toFixed(0)} kg):</strong> ${Math.round(bales)} bales</p>
      <h3>Contracting Cost per Hectare: $${fmtMoney(costPerHa)}</h3>
      <h3>Estimated Cost per Bale: $${fmtMoney(costPerBale)}</h3>
      ${lastCalc.hectaresProvided ? `
        <hr style="border:none;border-top:1px solid var(--line);margin:10px 0">
        <p class="tiny"><strong>Paddock:</strong> ${paddockSize} ha</p>
        <p class="tiny"><strong>Total Estimated Contracting Cost:</strong> $${fmtMoney(totalCost)}</p>
        <p class="tiny muted">Estimate only. Field conditions may change final cost.</p>
      `:''}
    </div>
  `;

  profitSection.style.display='block';
  profitResultsDiv.innerHTML='';
});

document.getElementById('calculate-profit-btn').addEventListener('click', ()=>{
  if(!lastCalc || !lastCalc.totalT){ profitResultsDiv.innerHTML = `<p class="tiny" style="color:#8B0000">Run the main calculation first.</p>`; return; }
  err.hayprice.textContent=''; err.grainprice.textContent='';
  const hayType = hayTypeSel.value;
  const isMedic = hayType==='medic';

  const hayPrice = parseFloat(document.getElementById('hay-price').value);
  const grainPriceRaw = document.getElementById('grain-price').value;
  const grainPrice = isMedic ? 0 : (parseFloat(grainPriceRaw) || 0);

  let bad=false;
  if(!hayPrice || hayPrice<=0){ err.hayprice.textContent='Enter hay price (>0).'; bad=true; }
  if(!isMedic && lastCalc.expectedGrain>0 && (!grainPrice || grainPrice<=0)){ err.grainprice.textContent='Enter grain price (>0).'; bad=true; }
  if(bad){ profitResultsDiv.innerHTML=''; return; }

  const totalHayRev = lastCalc.totalT * hayPrice;
  const totalHayProfit = totalHayRev - lastCalc.totalCost;
  const profitPerHa = totalHayProfit / lastCalc.paddockSize;

  let perBale=0, perBaleRev=0;
  if(lastCalc.bales>0){ perBale = totalHayProfit/lastCalc.bales; perBaleRev = totalHayRev/lastCalc.bales; }

  let compHtml='', diffHtml='';
  if(!isMedic && lastCalc.expectedGrain>0){
    const totalGrainRev = lastCalc.paddockSize * lastCalc.expectedGrain * grainPrice;
    const totalGrainProfit = totalGrainRev;
    const diff = totalHayProfit - totalGrainProfit;
    const color = diff>=0 ? 'var(--green)' : '#8B0000';
    const phrase = diff>=0 ? 'Hay is more profitable by' : 'Grain is more profitable by';
    compHtml = `
      <hr style="border:none;border-top:1px solid var(--line);margin:10px 0">
      <h3>Comparison</h3>
      <p><strong>Estimated Grain Revenue:</strong> $${fmtMoney(totalGrainRev)}</p>
      <p><strong>Estimated Grain Profit:</strong> $${fmtMoney(totalGrainProfit)}</p>
    `;
    diffHtml = `<p style="text-align:center;color:${color};font-weight:800;margin:8px 0">${phrase}: $${fmtMoney(Math.abs(diff))}</p>`;
  }

  profitResultsDiv.innerHTML = `
    <div class="result">
      <h3>Hay Financials (Net)</h3>
      <p><strong>Revenue per Bale:</strong> $${fmtMoney(perBaleRev)}</p>
      <p><strong>Total Revenue:</strong> $${fmtMoney(totalHayRev)}</p>
      <p><strong>Net Profit per Bale:</strong> $${fmtMoney(perBale)}</p>
      <p><strong>Net Profit per Hectare:</strong> $${fmtMoney(profitPerHa)}</p>
      <p><strong>Total Estimated Hay Profit:</strong> $${fmtMoney(totalHayProfit)}</p>
      ${compHtml}
      ${diffHtml}
      <p class="tiny muted" style="text-align:center">*Hay Net = Revenue − Contracting; Grain = Revenue (inputs excluded for envelope).</p>
    </div>
  `;
});

/* Print / Reset */
document.getElementById('btn-print').onclick = ()=>window.print();
document.getElementById('btn-reset').onclick = ()=>{
  document.getElementById('hayCalculator').reset();
  toggleGrainVisibility();
  resultsDiv.innerHTML='';
  profitResultsDiv.innerHTML='';
  profitSection.style.display='none';
  modeNote.style.display='none';
};

/* ===== Yield Guide samples (persist + PDF) ===== */
const samplesWrap = document.getElementById('samples');
const avgOut = document.getElementById('avg-dm-yield');

function sampleTemplate(index, data={}){
  const W = data.W??''; const SW = data.SW??''; const SD = data.SD??'';
  return `
  <div class="sample" data-index="${index}">
    <h3 style="margin-top:0">Sample ${index+1}</h3>
    <label>Wet biomass in 1 m² (W<sub>wet</sub>, g)</label>
    <input type="number" step="any" inputmode="decimal" class="s-wet" placeholder="e.g., 1200" value="${W}">
    <label>Sub-sample wet (S<sub>wet</sub>, g)</label>
    <input type="number" step="any" inputmode="decimal" class="s-sub-wet" placeholder="e.g., 100" value="${SW}">
    <label>Sub-sample dry (S<sub>dry</sub>, g)</label>
    <input type="number" step="any" inputmode="decimal" class="s-sub-dry" placeholder="e.g., 35" value="${SD}">
    <div class="tiny muted" data-out="dm">DM%: 0.00%</div>
    <div class="tiny muted" data-out="wdry">W<sub>dry</sub> (g): 0.00</div>
    <div class="tiny muted" data-out="tpha">DM Yield (t/ha): 0.00</div>
  </div>`;
}

let SAMPLES = [];

function addSample(data={}){
  const idx = SAMPLES.length;
  SAMPLES.push({W:0,SW:0,SD:0,dm:0,wdry:0,tpha:0});
  const div = document.createElement('div');
  div.innerHTML = sampleTemplate(idx, data);
  samplesWrap.appendChild(div.firstElementChild);
  bindSample(idx);
  if(data.W||data.SW||data.SD){
    const el = samplesWrap.querySelector(`.sample[data-index="${idx}"]`);
    computeSample(idx, el);
  }
  updateSummary();
  persistSamples();
}
function clearSamples(){
  SAMPLES = [];
  samplesWrap.innerHTML='';
  updateSummary();
  persistSamples();
}
function bindSample(i){
  const el = samplesWrap.querySelector(`.sample[data-index="${i}"]`);
  ['s-wet','s-sub-wet','s-sub-dry'].forEach(cls=>{
    el.querySelector('.'+cls).addEventListener('input', ()=>{ computeSample(i, el); updateSummary(); persistSamples(); });
  });
}
function computeSample(i, el){
  const W  = parseFloat(el.querySelector('.s-wet').value)||0;
  const SW = parseFloat(el.querySelector('.s-sub-wet').value)||0;
  const SD = parseFloat(el.querySelector('.s-sub-dry').value)||0;
  SAMPLES[i].W=W; SAMPLES[i].SW=SW; SAMPLES[i].SD=SD;
  let dm=0, wdry=0, tpha=0;
  if(SW>0 && SD>0){ dm = (SD/SW)*100; }
  if(W>0 && dm>0){ wdry = W * (dm/100); tpha = wdry/100; }
  SAMPLES[i].dm=dm; SAMPLES[i].wdry=wdry; SAMPLES[i].tpha=tpha;
  el.querySelector('[data-out="dm"]').innerHTML   = `DM%: ${dm.toFixed(2)}%`;
  el.querySelector('[data-out="wdry"]').innerHTML = `W<sub>dry</sub> (g): ${wdry.toFixed(2)}`;
  el.querySelector('[data-out="tpha"]').innerHTML = `DM Yield (t/ha): ${tpha.toFixed(2)}`;
}
function updateSummary(){
  const valid = SAMPLES.filter(s=>s.tpha>0).map(s=>s.tpha);
  const avg = valid.length? (valid.reduce((a,b)=>a+b,0)/valid.length) : 0;
  avgOut.textContent = avg.toFixed(2);
}

/* Persist guide inputs */
function persistSamples(){
  const payload = SAMPLES.map((s,i)=>{
    const el = samplesWrap.querySelector(`.sample[data-index="${i}"]`);
    if(!el) return {W:0,SW:0,SD:0};
    return {
      W: el.querySelector('.s-wet').value || '',
      SW: el.querySelector('.s-sub-wet').value || '',
      SD: el.querySelector('.s-sub-dry').value || ''
    };
  });
  localStorage.setItem('yieldGuideSamples', JSON.stringify(payload));
}
function restoreSamples(){
  const raw = localStorage.getItem('yieldGuideSamples');
  if(!raw){ addSample(); addSample(); addSample(); return; }
  try{
    const arr = JSON.parse(raw);
    if(arr.length===0){ addSample(); addSample(); addSample(); return; }
    arr.forEach(s=>addSample(s));
  }catch{ addSample(); addSample(); addSample(); }
}

document.getElementById('add-sample').onclick = ()=>addSample();
document.getElementById('clear-samples').onclick = ()=>clearSamples();
document.getElementById('push-to-calculator').onclick = ()=>{
  const val = parseFloat(avgOut.textContent)||0;
  if(val>0){
    document.getElementById('estimatedHayYieldPerHa').value = val.toFixed(2);
    activate('calc');
    window.scrollTo({top:0, behavior:'smooth'});
  }
};

/* Export Yield Guide PDF */
document.getElementById('export-yield-pdf').onclick = ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
  let y = 15;
  doc.setFontSize(16); doc.text('Yield Guide Results', 10, y); y+=8;
  doc.setFontSize(11);
  SAMPLES.forEach((s,i)=>{
    const W = (samplesWrap.querySelector(`.sample[data-index="${i}"]`)?.querySelector('.s-wet').value)||'-';
    const SW= (samplesWrap.querySelector(`.sample[data-index="${i}"]`)?.querySelector('.s-sub-wet').value)||'-';
    const SD= (samplesWrap.querySelector(`.sample[data-index="${i}"]`)?.querySelector('.s-sub-dry').value)||'-';
    doc.text(`Sample ${i+1}: Wwet=${W}g, Swet=${SW}g, Sdry=${SD}g`, 10, y);
    y+=6; if(y>280){ doc.addPage(); y=15; }
  });
  y+=4; doc.text(`Average DM Yield: ${avgOut.textContent} t/ha`, 10, y);
  doc.save('Yield_Guide_Results.pdf');
};

/* Init */
window.onload = function(){
  activate('calc');
  toggleGrainVisibility();
  renderConvTab();
  restoreSamples();

  if(typeof renderMathInElement!=='undefined'){
    renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false}]});
  }
};

document.getElementById('btn-print').onclick = ()=>window.print();
</script>
</body>
</html>
